```{r include = FALSE}
# Filter by waterbody

# value.to.match <- '{{value.to.match}}' 

# Import processed remote sensing data and chl-a data
gee <- readRDS(paste0(drive_dir, "sensors_all_aggregated_", date1, "_", date2, ".RDS"))
# Add chl-a data as needed

gee_tidy <- gee %>% 
  filter(waterbody %in% value.to.match) %>%
  select(waterbody, everything())


#list of maps for each waterbody (some are split into two maps N and S)
nir_paths <- Sys.glob(paste0(drive_dir, "/nir_red/d_", date2minus14, "_", date2, "/*.jpg"))
nir_paths <- nir_paths[grepl(value.to.match, nir_paths)]
nir_paths

fai_paths <- Sys.glob(paste0(drive_dir, "/fai_ndwi/d_", date2minus14, "_", date2, "/*.jpg"))
fai_paths <- fai_paths[grepl(value.to.match, fai_paths)]

```


At {{value.to.match}}, timeseries data is processed for at least three locations as shown in the figure below. 


```{r echo = FALSE}
bimonthly <- function(x) {
  x_range <- range(x, na.rm = TRUE)
  
  date_range <- c(
    floor_date(x_range[1], "month"),
    ceiling_date(x_range[2], "month")
  )
  monthly <- seq(date_range[1], date_range[2], by = "1 month")
  
  sort(c(monthly, monthly + days(14)))
}

```

```{r echo = FALSE, message = FALSE, out.width= '100%'}

#Timeseries plots

gee_plot <- gee_tidy %>% 
  filter(waterbody %in% value.to.match) %>%
  select(waterbody, everything())

p <- ggplot(gee_plot, 
       aes(date, nir_red_br, lty = pt_loc)) +
  geom_rect(aes(xmin = as.Date(date2, "%Y-%m-%d")-14, xmax = as.Date(date2, "%Y-%m-%d"), 
                ymin = -Inf, ymax = Inf), 
            fill = "pink",
            alpha = 0.02) +
  geom_line() +
  geom_hline(yintercept = 1, color = "blue", lty = "dashed") +
  scale_linetype_discrete(name = "Point Location", 
                          labels = c("Edge (E)", "Near Edge (NE)", "Open Water (OW)")) +
  theme_cowplot(10) +
  labs(x = "",
       y = "NIR:Red Ratio", 
       title = gee_plot$waterbody[1]) +
  scale_x_date(date_labels = "%m/%d", date_breaks = "month") + #or change to breaks = bimonthly
  facet_wrap(~sampling_p, ncol = 2, scales = "free_x") 

if (value.to.match == "Chatfield Reservoir") {
  ggsave(filename = paste0("C:/projects/dw/git/denverwater_algae/plots/", value.to.match, ".jpg"), height = 8)
} else {
  ggsave(filename = paste0("C:/projects/dw/git/denverwater_algae/plots/", value.to.match, ".jpg"))
}


plot_paths <- Sys.glob(paste0("C:/projects/dw/git/denverwater_algae/plots/*.jpg"))
plot_paths <- plot_paths[grepl(value.to.match, plot_paths)]
```

``` {r echo = FALSE}

knitr::include_graphics(plot_paths)

```

*NIR:Red time series from `r date1` to `r date2`. The blue dashed line is at NIR:Red = 1, the threshold above which algal concentrations could lead to odor or taste concerns. The pink band shows the most recent two weeks, from `r date2minus14` to `r date2`, that are mapped below.*



The following images are maps showing potential algal blooms in {{value.to.match}} from `r date2minus14` to `r date2`.



```{r echo = FALSE, out.width = '100%'}

knitr::include_graphics(nir_paths)

```
*NIR:Red mapped from `r date2minus14` to `r date2` study period. Darker colors indicate higher NIR:Red exceedances.*
  
  
```{r echo = FALSE, out.width = '100%'}
knitr::include_graphics(fai_paths)
```
*FAI-NDWI mapped from `r date2minus14` to `r date2` study period. Darker colors indicate higher FAI-NDWI exceedances. If no  FAI-NDWI appears in the legend or on the map, then no threshold exceedances occurred between `r date2minus14` and `r date2`*
  
  



```{r include = FALSE}
# Count above thresholds
gee_table <- gee_tidy %>% 
  mutate(cyano = case_when(fai >= fai_thresh & ndwi >= ndwi_thresh ~ 1,
                           TRUE ~ 0)) %>%
  filter(date > date2minus14)

over_thresh <- gee_table %>% 
  group_by(sampling_p, pt_loc) %>% 
  summarise(nir_red_n_over = sum(nir_red_br >= nir_red_thresh),
            fai_ndwi_n_over = sum(cyano),
            n_obs = n()) %>% 
  ungroup() %>%
  mutate(nir_red_pct_over = round(nir_red_n_over / n_obs * 100,1),
         fai_ndwi_pct_over = round(fai_ndwi_n_over / n_obs * 100,1)) %>%
  select(sampling_p, pt_loc, n_obs, nir_red_n_over, nir_red_pct_over, fai_ndwi_n_over, fai_ndwi_pct_over) %>%
  mutate(nir_combine = paste0(nir_red_n_over, " (", nir_red_pct_over, "%)"), 
         fai_combine = paste0(fai_ndwi_n_over, " (", fai_ndwi_pct_over, "%)"),
         n_obs = as.character(n_obs)) %>%
  select(sampling_p, pt_loc, n_obs, nir_combine, fai_combine) %>%
  rename("Point location" = "sampling_p",
         "Type" = "pt_loc",
         "Number of observations" = "n_obs",
         "NIR:Red exceedance count (%)" = "nir_combine",
         "FAI-NDWI exceedance count (%)" = "fai_combine")
  
```


Tabulated exceedances for each point location in {{value.to.match}} between `r date2minus14` and `r date2` are presented below. NIR:Red values greater than 1 indicate an exceedance and pixels with FAI ≥ 0.05 AND NDWI ≥ 0.63 indicate an exceedance.

```{r echo = FALSE, results = 'asis'}


# Function to make table fit to page margins
fitflextabletopage <- function(ft, pgwidth = 6){
  ft_out <- ft %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

over_thresh %>%
  flextable() %>%
  fitflextabletopage

```
*"Type" refers to the location of the monitoring points along the water's edge (E = edge, NE = near edge, and OW = open water)*


