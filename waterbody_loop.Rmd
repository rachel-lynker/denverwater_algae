The following images are maps showing potential harmful algal blooms in {{value.to.match}} from `r date1` to `r date2`.

```{r include = FALSE}
# Filter by waterbody

# value.to.match <- '{{value.to.match}}' 

# Import processed remote sensing data and chl-a data
gee <- readRDS(paste0(drive_dir, "sensors_all_aggregated_", date1, "_", date2, ".RDS"))
# Add chl-a data as needed

gee_tidy <- gee %>% 
  filter(waterbody %in% value.to.match) %>%
  select(waterbody, everything())


#list of maps for each waterbody (some are split into two maps N and S)
nir_paths <- Sys.glob(paste0(drive_dir, "/nir_red/d_", date1, "_", date2, "/*.jpg"))
nir_paths <- nir_paths[grepl(value.to.match, nir_paths)]
nir_paths

fai_paths <- Sys.glob(paste0(drive_dir, "/fai_ndwi/d_", date1, "_", date2, "/*.jpg"))
fai_paths <- fai_paths[grepl(value.to.match, fai_paths)]

```


```{r echo = FALSE, out.width = '100%'}

knitr::include_graphics(nir_paths)

```
*NIR:Red mapped from `r date1` to `r date2` study period. Darker colors indicate higher NIR:Red exceedances. MON in the site name means monitor.*
  
  
```{r echo = FALSE, out.width = '100%'}
knitr::include_graphics(fai_paths)
```
*FAI-NDWI mapped from `r date1` to `r date2` study period. Darker colors indicate higher FAI-NDWI exceedances.*
  
  
  At {{value.to.match}} timeseries data is processed for at least four locations as shown in the figure below. At each monitoring point, three different timeseries are collected at three sites spaced 10m apart. These additional points are intended to minimize false positive threshold exceedances since vegetation at the waterâ€™s edge can confuse both algorithms. "MON" in the site name means monitor, and the additional point location names correspond to sampling point names previously used at Denver Water .


```{r echo = FALSE, message = FALSE, out.width= '100%', fig.cap = " '{{value.to.match}}' test"}

gee_plot <- gee_tidy %>% 
  filter(waterbody %in% value.to.match) %>%
  select(waterbody, everything())

p <- ggplot(gee_plot, 
       aes(date, nir_red_br, lty = pt_loc)) +
  geom_line() +
  geom_hline(yintercept = 1, color = "blue", lty = "dashed") +
  scale_linetype_discrete(name = "Point Location", 
                          labels = c("Edge", "Near edge", "Open water")) +
  theme_cowplot(12) +
  labs(x = "Date",
       y = "NIR:Red Ratio", 
       title = gee_plot$waterbody[1]) +
  facet_wrap(~sampling_p, scales = "free_y")

ggsave(filename = paste0("C:/projects/dw/git/denverwater_algae/plots/", value.to.match, ".jpg"))

plot_paths <- Sys.glob(paste0("C:/projects/dw/git/denverwater_algae/plots/*.jpg"))
plot_paths <- plot_paths[grepl(value.to.match, plot_paths)]
```

``` {r echo = FALSE}

knitr::include_graphics(plot_paths)

```

NIR:Red time series from `r date1` to `r date2` study period. The blue dashed line is at NIR:Red = 1."

```{r include = FALSE}
# Count above thresholds
gee_table <- gee_tidy %>% 
  mutate(cyano = case_when(fai >= fai_thresh & ndwi >= ndwi_thresh ~ 1,
                           TRUE ~ 0))

over_thresh <- gee_table %>% 
  group_by(sampling_p, pt_loc) %>% 
  summarise(nir_red_n_over = sum(nir_red_br >= nir_red_thresh),
            fai_ndwi_n_over = sum(cyano),
            n_obs = n()) %>% 
  ungroup() %>%
  mutate(nir_red_pct_over = round(nir_red_n_over / n_obs * 100,1),
         fai_ndwi_pct_over = round(fai_ndwi_n_over / n_obs * 100,1)) %>%
  select(sampling_p, pt_loc, n_obs, nir_red_n_over, nir_red_pct_over, fai_ndwi_n_over, fai_ndwi_pct_over) %>%
  mutate(nir_combine = paste0(nir_red_n_over, " (", nir_red_pct_over, "%)"), 
         fai_combine = paste0(fai_ndwi_n_over, " (", fai_ndwi_pct_over, "%)"),
         n_obs = as.character(n_obs)) %>%
  select(sampling_p, pt_loc, n_obs, nir_combine, fai_combine) %>%
  rename("Point location" = "sampling_p",
         "Type" = "pt_loc",
         "Number of observations" = "n_obs",
         "NIR:Red exceedance count (%)" = "nir_combine",
         "FAI-NDWI exceedance count (%)" = "fai_combine")
  
```

```{r echo = FALSE, results = 'asis', tab.cap = "Mapped exceedances for each point location. NIR:Red values greater than 1 indicate an exceedance and FAI-NDWI output values greater than 0.63 indicate an exceedance."}


# Function to make table fit to page margins
fitflextabletopage <- function(ft, pgwidth = 6){
  ft_out <- ft %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
}

over_thresh %>%
  flextable() %>%
  fitflextabletopage

```

